<html>
	<head>
		<script src="jquery-1.5.1.min.js"></script> 
		<script src="gamemodel.js"></script>
		<script src="PhiloGL.js"></script> 
		<script src="/socket.io/socket.io.js"></script> 

		<script id="shader-fs" type="x-shader/x-fragment"> 
		  #ifdef GL_ES
		  precision highp float;
		  #endif
		 
		  void main(void) {
		    gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
		  }
		</script> 
		 
		<script id="shader-vs" type="x-shader/x-vertex"> 
		  attribute vec3 aVertexPosition;
		
		  uniform mat4 uMVMatrix;
		  uniform mat4 uPMatrix;
		 
		  void main(void) {
		    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
		  }
		</script>

		<script>

			var idealTimePerFrame = 1000 / 30;
			var leftover = 0.0;
			var timeAtLastFrame = new Date().getTime();	

			function webGLStart() {
			  PhiloGL('game', {
			    program: {
			      from: 'ids',
			       vs: 'shader-vs',
			       fs: 'shader-fs'
			    },
			    onError: function() {
			      alert("You probably don't have WebGL - sorry");
			    },
			    onLoad: function(app) {
				var gl = app.gl,
				canvas = app.canvas,
				program = app.program,
				camera = app.camera;

				gl.viewport(0, 0, canvas.width, canvas.height);
				camera.projection.frustum(-250, 250, -250, 250, -1, 1);
				gl.clearColor(0, 0, 255, 1);
				gl.clearDepth(1);
				gl.enable(gl.DEPTH_TEST);
				gl.depthFunc(gl.LEQUAL);

				program.setBuffers({       
					'square': {
						attribute: 'aVertexPosition',
						value: new Float32Array([1, 1, 0, -1, 1, 0, 1, -1, 0, -1, -1, 0]),
						size: 3
					}
				});

				setInterval( function() {
					tick(app);
				}, 50);				
			    }
			  });  
			}


			function tick(app){
				
				var timeAtThisFrame = new Date().getTime();
				var diff = (timeAtThisFrame - timeAtLastFrame) + leftover;

				var frames = Math.floor(diff / idealTimePerFrame);
				leftover = diff - (frames * idealTimePerFrame);	
				
				for(i = 0 ; i < frames ; i++){
					doLogic(app);
				}

				renderScene(app);

				timeAtLastFrame = timeAtThisFrame;	
			}

			function doLogic(app){
				DoGameLoop();
			}

			function renderScene(app){
				var gl = app.gl,
				canvas = app.canvas,
				program = app.program,
				camera = app.camera;
			
				gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
				program.setBuffer('square');
				program.setUniform('uPMatrix', camera.projection);

				var g=GameState;
				renderQuad(app, g.Pads[0]);
				renderQuad(app, g.Pads[1]);
				renderQuad(app, g.Ball);
				
			}

			function renderQuad(app, model)
			{
				var gl = app.gl,
				canvas = app.canvas,
				program = app.program,
				camera = app.camera;
			
				camera.modelView.id();
				camera.modelView.$translate(model.x, model.y, -1);
				camera.modelView.$scale(model.width, model.height, 1);				
			
				program.setUniform('uMVMatrix', camera.modelView);		
				gl.drawArrays(gl.TRIANGLE_STRIP, 0, 4);	
				
				console.log('Rendering: ' + model.width + ' ' + model.height + ' ' + model.x + ' ' + model.y);
			}
			
	
		</script>

		<script>
		//	$(document).ready(webGLStart);
		</script>
	</head>
	<body onload="webGLStart();">		
		<canvas id="game" style="border: none;" width="500" height="500">
		</canvas>
	</body>
</html>
