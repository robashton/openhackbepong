<html>
	<head>
		<script src="jquery-1.5.1.min.js"></script> 
		<script src="PhiloGL.js"></script> 
		<script src="/socket.io/socket.io.js"></script> 
		<script src="/pongmodel.js"></script>
		<script src="/renderer.js"></script>
		<script src="/messaging.js"></script>
		<script src="/coordination.js"></script>
		<script src="/controllers.js"></script>

		<script id="shader-fs" type="x-shader/x-fragment"> 
		  #ifdef GL_ES
		  precision highp float;
		  #endif

			varying vec2 vTextureCoord;
		   uniform sampler2D uSampler;
		 
		  void main(void) {
		    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));		
		  }
		</script> 
		 
		<script id="shader-vs" type="x-shader/x-vertex"> 
		  attribute vec3 aVertexPosition;
		  attribute vec2 aTextureCoord;
		
		  uniform mat4 uMVMatrix;
		  uniform mat4 uPMatrix;

		  varying vec2 vTextureCoord;
		 
		  void main(void) {
		    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
			 vTextureCoord = aTextureCoord;
		  }
		</script>


	<script type="text/javascript">

		$(document).ready(function(){

			$('#message').text('Waiting for a partner to play with');

			var socket = new io.Socket(); 
			socket.connect(); 

	 		socket.on('connect', function(){

			 });
			 socket.on('message', function(data){

				switch(data.message)
				{
					case 'start':
						$('#message').text('Game has started');
					break;
		         case "otherdisconnected":						
						$('#message').text('The other player has disconnected, hit refresh if you want another game'); 
					break;			
				}	
			    coordinator.processReceivedMessage(data);	
			 });
			 socket.on('disconnect', function(){ 
					$('#message').text('You have been disconnected - hit refresh to find another game');	
			 });

			var pongModel = new Pong.GameModel(-250, 250, 250, -250);
			var renderer = new Renderer.Engine('game', pongModel);
			var publisher = new Messaging.Publisher(socket);
			var controller = new Controllers.GameController(pongModel, publisher);
			var coordinator = new Coordination.Coordinator(renderer, controller);

			setInterval(function() {  coordinator.onTick(); }, 1000 / 30);
         var keyCodes = {S:83,X:88};
			document.onkeydown = function(event) { 
				if(event.keyCode == keyCodes.S) controller.registerPaddleUpState(true);
				if(event.keyCode == keyCodes.X) controller.registerPaddleDownState(true);
			};
			document.onkeyup = function(event) { 
				if(event.keyCode == keyCodes.S) controller.registerPaddleUpState(false);
				if(event.keyCode == keyCodes.X) controller.registerPaddleDownState(false);
			};

			$('#startGame').click(function(){
				$('#message').text('Request for a new game has been sent, waiting for a response');
				publisher.send({ message: 'startgame' });
			});
		
		});

	</script>

	</head>
	<body>		
    	<div id="playing">

			<p id="message">Waiting for the game to start</p>
			<canvas id="game" style="border: none;" width="500" height="500"></canvas>
			
		</div>
	</body>
</html>
