<html>
	<head>
		<script src="jquery-1.5.1.min.js"></script> 
		<script src="PhiloGL.js"></script> 
		<script src="/socket.io/socket.io.js"></script> 
		<script src="/PongGameStates.js"></script>
		<script src="/pongmodel.js"></script>
		<script src="/renderer.js"></script>
		<script src="/messaging.js"></script>
		<script src="/coordination.js"></script>
		<script src="/controllers.js"></script>

		<script id="shader-fs" type="x-shader/x-fragment"> 
		  #ifdef GL_ES
		  precision highp float;
		  #endif

			varying vec2 vTextureCoord;
		   uniform sampler2D uSampler;
		 
		  void main(void) {
		    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));		
		  }
		</script> 
		 
		<script id="shader-vs" type="x-shader/x-vertex"> 
		  attribute vec3 aVertexPosition;
		  attribute vec2 aTextureCoord;
		
		  uniform mat4 uMVMatrix;
		  uniform mat4 uPMatrix;

		  varying vec2 vTextureCoord;
		 
		  void main(void) {
		    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
			 vTextureCoord = aTextureCoord;
		  }
		</script>


	<script type="text/javascript">

		$(document).ready(function(){

			$('#message').text('Waiting for a partner to play with');

			var socket = new io.Socket(); 

			var pongModel = new Pong.GameModel(-250, 250, 250, -250);
			var renderer = new Renderer.Engine('game', pongModel);
			var publisher = new Messaging.Publisher(socket);
			var controller = new Controllers.GameController(pongModel, publisher);
			var coordinator = new Coordination.Coordinator(renderer, controller);
		
			controller.onChangeState(function(){
				switch(this.currentState){
					case PongGameStates.OtherPlayerDisconnected:
						$('#message').text('You have been disconnected - hit refresh to find another game');
					break;
					case PongGameStates.StartRound:
						if(controller.isGoingFirst){
							$('#message').text('You\'re going first, press space to begin!');
						} else {
							$('#message').text('they\'re going first, be on your guard!');
						}
					break;
					case PongGameStates.Playing:
						$('#message').text('It\'s on - good luck folks!');
					break;
					case PongGameStates.PlayerLeftWins:
						$('#message').text('Left player has won- hit refresh to find another game');
					break;
					case PongGameStates.PlayerRightWins:
						$('#message').text('Right player has won- hit refresh to find another game');
					break;
					case PongGameStates.PlayerScored:
						// Update score :-)
					break;
				}
			});


			socket.connect(); 
	 		socket.on('connect', function(){

			 });
			 socket.on('message', function(data){
			    coordinator.processReceivedMessage(data);	
			 });
			 socket.on('disconnect', function(){ 
					$('#message').text('You have been disconnected - hit refresh to find another game');	
			 });

			setInterval(function() {  coordinator.onTick(); }, 1000 / 30);

         var keyCodes = {S:83,X:88, Space: 32};
			document.onkeydown = function(event) { 
				if(event.keyCode == keyCodes.S) controller.registerPaddleUpState(true);
				if(event.keyCode == keyCodes.X) controller.registerPaddleDownState(true);
				if(event.keyCode == keyCodes.Space) controller.registerPaddleSpaceState(true);
			};
			document.onkeyup = function(event) { 
				if(event.keyCode == keyCodes.S) controller.registerPaddleUpState(false);
				if(event.keyCode == keyCodes.X) controller.registerPaddleDownState(false);
				if(event.keyCode == keyCodes.Space) controller.registerPaddleSpaceState(false);
			};		
		});

	</script>

	</head>
	<body>		
    	<div id="playing">

			<p id="message">Waiting for the game to start</p>
			<canvas id="game" style="border: none;" width="500" height="500"></canvas>
			
			<div class="scorecontainer">
				<span id="score"></span>
			</div>
		</div>
	</body>
</html>
