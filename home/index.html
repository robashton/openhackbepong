<html>
	<head>
		<script src="jquery-1.5.1.min.js"></script> 
		<script src="PhiloGL.js"></script> 
		<script src="/socket.io/socket.io.js"></script> 
		<script src="/pongmodel.js"></script>
		<script src="/renderer.js"></script>
		<script src="/messaging.js"></script>
		<script src="/coordination.js"></script>
		<script src="/controllers.js"></script>

		<script id="shader-fs" type="x-shader/x-fragment"> 
		  #ifdef GL_ES
		  precision highp float;
		  #endif

			varying vec2 vTextureCoord;
		   uniform sampler2D uSampler;
		 
		  void main(void) {
		    gl_FragColor = texture2D(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));		
		  }
		</script> 
		 
		<script id="shader-vs" type="x-shader/x-vertex"> 
		  attribute vec3 aVertexPosition;
		  attribute vec2 aTextureCoord;
		
		  uniform mat4 uMVMatrix;
		  uniform mat4 uPMatrix;

		  varying vec2 vTextureCoord;
		 
		  void main(void) {
		    gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
			 vTextureCoord = aTextureCoord;
		  }
		</script>


	<script type="text/javascript">

		$(document).ready(function(){

			$('#waiting').show();
			$('#playing').hide();
			$('#zombied').hide();

			var socket = new io.Socket(); 
			socket.connect(); 

	 		socket.on('connect', function(){

			 });
			 socket.on('message', function(data){
				console.log('Received Message At Top: ' + data.message);

				switch(data.message)
				{
					case 'start':

						$('#waiting').hide();
						$('#playing').show();

					break;
		         case "otherdisconnected":
						
						$('#playing').hide();
						$('#zombied').show();		 

					break;
					default:
						controller.translateMessageToModel(data);			
					break;				
				}	
			 });
			 socket.on('disconnect', function(){ 
					alert('You have been disconnected');
			 });

			var pongModel = new Pong.GameModel(500, 500);
			var renderer = new Renderer.Engine('game', pongModel);
			var publisher = new Messaging.Publisher(socket);
			var controller = new Controllers.GameController(pongModel, publisher);
			var coordinator = new Coordination.Coordinator(renderer, controller);

			setInterval(function() {  coordinator.onTick(); }, 1000 / 30);
         var keyCodes = {S:83,X:88};
			document.onkeydown = function(event) { 
				if(event.keyCode == keyCodes.S) controller.registerPaddleUpState(true);
				if(event.keyCode == keyCodes.X) controller.registerPaddleDownState(true);
			};
			document.onkeyup = function(event) { 
				if(event.keyCode == keyCodes.S) controller.registerPaddleUpState(false);
				if(event.keyCode == keyCodes.X) controller.registerPaddleDownState(false);
			};

			$('#startGame').click(function(){
				$('#waiting').show();
				$('#zombied').hide();
				publisher.send({ message: 'startgame' });
			});
		
		});

	</script>

	</head>
	<body>		

		<div id="waiting">
			<p>Waiting for the game to start</p>
		</div>

		<div id="playing">
			<canvas id="game" style="border: none;" width="500" height="500">
				
			</canvas>
		</div>

		<div id="zombied">
			<p>The other player left the game, click <span id="startGame">here</span> to start a new game or close this window<p>
		</div>
	</body>
</html>
